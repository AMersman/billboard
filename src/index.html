<title>Project 2</title>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="http://hammerjs.github.io/dist/hammer-time.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>

    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.css" />
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" charset="utf-8"></script>

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3-queue.v2.min.js" charset="utf-8"></script>

    <link rel="stylesheet" href="../bebas_neue/bebas_neue.css"/>

    <style>
        input.ui-slider-input {
            font-size: 20px;
            line-height: 20px;
            border: 2px solid #323232;
            padding: 5px;
            width: 50px;
        }
        .ui-rangeslider .ui-rangeslider-sliders {
            margin: 0px 80px 0px 80px;
        }

        a.ui-slider-handle.ui-btn.ui-shadow.ui-btn-null{
            background: #f3f3f3;
            width: 12px;
            height: 12px;
            border-radius: 50px;
            border: 2px solid #323232;
        }
        /* Unchecked Button*/
        button.ui-btn.ui-btn-inline {
            color: #323232;
            border: 2px solid #323232;
            text-transform: uppercase;
            background: none;
            font-weight: 600;
            font-size: 20px;
            line-height: 20px;
            padding: 8px 8px 8px 8px;
            margin: 0px 10px 20px 10px;
        }

        #filter-toggle {
            margin-top: 20px;
        }

        button.ui-btn.ui-btn-inline.ui-btn-active {
            color: white;
            background: #323232;
        }
        button.ui-btn.ui-btn-inline:hover {
            opacity: .75;
        }
        div.ui-slider-bg.ui-btn-active {
            background: #1D96E7;
        }
        .ui-slider-bg, .ui-slider-track {
            border: none;
        }
        #year-slider {
            margin: 0px 20px 20px 20px;
        }
        body, input, button {

            font-family: "bebas_neuebold";
/*    font-family: "Copperplate Gothic Bold";
*/    fill: black;
line-height: 1.25;
min-height: 100%;
width: 100%;
}
body {
    position: relative;
}

header {
    text-align: center;
    padding: 30px;
}
header #title {
    font-size: 40px;
}
header #subtitle {
    font-size: 20px;
}
.container {
    padding: 0px 60px 0px 60px;
}
#wrap {
    margin: 0px 0px 100px 0px;
}
#cover {
    background: white;
    z-index: 10;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: .7;
}

footer {
    position:fixed;
    left:0px;
    bottom:0px;
    width:100%;
    background: white;
    border-top: 2px solid #323232;
    opacity: .95;
}

svg {
    border: solid #323232 1px;
}
path.line {
    stroke: #323232;
    fill: none;;
}

/*DROPDOWN BUTTON FOR TREND GRAPH CSS*/
.dropbtn {
    margin-left: 70px;
    background-color: white;
    color: black;
    padding: 10px;
    font-size: 14px;
    border: solid black;
    cursor: pointer;
    height: 50px;
    width: 100px;
}

.dropbtn:hover, .dropbtn:focus {
    border: solid #C0C0C0;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    margin-left: 70px;
    display: none;
    position: absolute;
    background-color: white;
    min-width: 70px;
    overflow: auto;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
}

.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}

.dropdown a:hover {background-color: #f1f1f1}

.show {display:block;}
</style>
</head>

<body>
    <div id="cover"></div>
    <script>
        function animStart() {
            $('#cover').fadeIn("fast");
            NProgress.start();
        }
        function animStop() {
            $('#cover').fadeOut("fast");
            NProgress.done();
        }
        NProgress.start();
    </script>
    <div id="wrap">
        <header>
            <div class="container">
                <h1 id="title">Billboard's Top 100 Songs</h1>
                <h4 id="subtitle">66 years of lyrical data, visualized</h4>
            </div>
        </header>
        <div class="dropdown">
          <button id="button" onclick="myFunction()" class="dropbtn">Sentiment</button>
          <div id="myDropdown" class="dropdown-content">
            <a href="javascript:updateGraph('Sentiment')">Sentiment</a>
            <a href="javascript:updateGraph('Readability')">Readability</a>
            <a href="javascript:updateGraph('Repetition')">Repetition</a>
        </div>
    </div>
    <div id="trend" class="container"></div>
    <div id="scatter" class="container"></div>
    <div id="stats" class="container"></div>
</div>
<footer>
    <div class="container">
        <button class="ui-btn ui-btn-inline ui-btn-active" id="filter-toggle">EXPAND FILTERS</button>
        <div id="filter-controls" style="display: none;">
            <form>
                <p>Year:</p>
                <div data-role="rangeslider" id="year-slider" data-mini="true">
                    <input oninput="animStart(); visualize(filter(data, getSliderMin(), getSliderMax(), getActiveGenres()));" type="range" name="year-min" id="year-min" min="1950" max="2015" value="1950">
                    <input oninput="animStart(); visualize(filter(data, getSliderMin(), getSliderMax(), getActiveGenres()));" type="range" name="year-max" id="year-max" min="1950" max="2015" value="2015">
                </div>
            </form>
            <p>Genres:</p>
            <div class="genres"></div>
        </div>
    </div>
</footer>

<script>
    var agg_genres = ["all-genres", "rock", "alternative/indie", "electronic/dance", "soul", "classical/soundtrack", "pop", "hip-hop/rnb", "disco", "swing", "folk", "country", "jazz", "religious", "blues", "reggae"];
    var genres = d3.select(".genres");
    genres.selectAll("button")
    .data(agg_genres)
    .enter()
    .append("button")
    .attr("class", "ui-btn ui-btn-inline ui-btn-active")
    .attr("id", function(d){return d;})
    .text(function(d){return d;});

    $("#filter-toggle").click(function() {
        if ($("#filter-controls").is(":visible")) {
            $(this).html("Expand Filters");
        }
        else {
            $(this).html("Collapse Filters");
        }
        $("#filter-controls").fadeToggle();
    });

        // Handle year slider events
        $( "#year-slider" ).on( "slidestop", function( event, ui ) {
            animStart();
            console.log("changed");
            visualize(filter(data, getSliderMin(), getSliderMax(), getActiveGenres()));
        } );

        // Handle genre filter events
        $(".genres  button.ui-btn.ui-btn-inline").click(function() {
            animStart();
            if ($(this).attr('id') == 'all-genres') {
                if ($(this).hasClass("ui-btn-active")) {
                    $(".genres  button.ui-btn.ui-btn-inline").removeClass("ui-btn-active");
                    visualize(filter(data, getSliderMin(), getSliderMax(), getActiveGenres()));
                }
                else {
                    $(".genres  button.ui-btn.ui-btn-inline").addClass("ui-btn-active");
                    visualize(filter(data, getSliderMin(), getSliderMax(), getActiveGenres()));
                }
            }
            else {
                if ($(this).hasClass("ui-btn-active")) {
                    $(this).removeClass("ui-btn-active");
                    $("#all-genres").removeClass("ui-btn-active");
                }
                else {
                    $(this).addClass("ui-btn-active");
                    var length = getActiveGenres().length;
                    if (length == 15) {
                        $("#all-genres").addClass("ui-btn-active");
                    }
                }
                visualize(filter(data, getSliderMin(), getSliderMax(), getActiveGenres()));
            }
        });

        // Filter data according to year & genre
        function filter(data, yearMin, yearMax, genres) {
            var years =  _.filter(data, function(item) {
                return item['year'] >= yearMin && item['year'] <= yearMax;
            });

            var allsongs = _.flatten(_.pluck(years, "songs"));
            if (typeof genres === 'undefined') {
                return allsongs;
            }
            else {
                var songs = _.filter(allsongs,function(song) {
                    return _.intersection(song['tags'], genres).length > 0;
                });
                return songs;
            }
        }

        // Re-draw elements
        function visualize(data) {
            document.getElementById("stats").innerText = data.length;
            document.getElementById("stats").innerText += JSON.stringify(_.pluck(data, "title"), null, 2);
            animStop();
        };

        // Load data & visualize it
        d3.json("data.json", function(error, json) {
            if (error) return console.warn(error);
            data = json;
            visualize(filter(data, getSliderMin(), getSliderMax(), getActiveGenres()));
            graphTrend(json);
            graphScatter(json);
        });

        // Getter Functions
        function getSliderMin() {
            return d3.select("#year-min")[0][0].value;
        }
        function getSliderMax() {
            return d3.select("#year-max")[0][0].value;
        }
        function getActiveGenres() {
            var activeGenres = [];
            $(".genres .ui-btn-active").each(function() {
                activeGenres.push($(this).attr('id'));
            });
            if (! activeGenres) {
                return [];
            }
            else if (_.contains(activeGenres, "all-genres")) {
                return undefined;
            }
            else {
                return activeGenres;
            }
        }

    </script>
    <script src="js/graph.js"></script>
    <script src="js/stats.js"></script>

</body>